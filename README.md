# Docserve

**Docserve** purpose is to make it easier to produce documentation for a project where you want to show different documentation to users with different roles.

**Warning (or not)**: much of this code produced with gpt 01-preview

This simple library solves the following problems:
- serve docs appropriate to the user's role, and only those docs.
- avoid having to create yml files for the docs created, just assume all the docs in a role folder are to be included

## Features

- **Role-Based Access Control**: Serve documentation to users based on their group memberships.
- **Reusable App**: Easily integrate into multiple Django projects.
- **MkDocs Integration**: Supports documentation generated by MkDocs, including themes like Material Design.
- **Easy Configuration**: Minimal setup required to get started.
- **Static Files Handling**: Manages static assets (CSS, JS) required by MkDocs documentation.

## Requirements

- Python 3.7 or higher
- Django 3.2 or higher
- MkDocs 1.4.2 or higher
- Optional: MkDocs Material theme if used

## Installation

1. **Install the Package**

   You can install `docserve` directly from your local source or via a package repository if published.

   ```bash
   pip install git+https://github.com/phoebebright/django-docserve

## Add to Installed Apps

In your project's settings.py, add docserve to the INSTALLED_APPS list:

    INSTALLED_APPS = [
        # ... other installed apps ...
        'docserve',
    ]

Point to the location of your source docs:

    DOCSERVE_DOCS_ROOT = os.path.join(BASE_DIR, 'docs')  # source .md files
    DOCSERVE_DOCS_SITE_ROOT = os.path.join(BASE_DIR, 'docs_site')  # where .html files will be put

or

    DOCSERVE_DOCS_ROOT = BASE_DIR / 'docs'    # source .md files
    DOCSERVE_DOCS_SITE_ROOT = BASE_DIR / 'docs_site'   # where .html files will be put


Include URLs

In your project's urls.py, include docserve URLs:

    from django.urls import path, include

    urlpatterns = [
         path('docs/', include(('docserve.urls', 'docserve'), namespace='docserve')),
         ...
    ]


## Add User Roles and Docs

The whole purpose of this library is to be able to supply different docs to different types of user.  The users role or roles can be based on the django groups they have or you can customise how you define this role.

If you want to use django groups and you don't already have the groups setup you can do that in the admin interface or programmatically like this:

    from django.contrib.auth.models import Group
    
    roles = ['admin', 'factory', 'distributor', 'support', 'user']
    for role in roles:
        Group.objects.get_or_create(name=role)
    Assign Users to Groups

Use the Django admin interface or scripts to assign users to the appropriate groups.

## Add your docs directory, role directory and docs

Create a docs directory wherever you specified in your setting DOCSERVE_DOCS_ROOT

For each role, create a subdirectory and add your .md files to that directory


## Build your Docs 

Each time you change the .md files, you will need to rebuild your docs.  To do this run two management commands:
          
        python manage.py generate_mkdocs_yml
        python manage.py build_docs

## Customisation

### Templates

To modify the index page, look at the page in docserve/templates/home_page.html and put your customised version into your project's templates directory under a docserve directory.

To customise the doc pages 

### URLs

If you don't want to use the /docs url, modify the url root in your urls.py, it should just work!



### Customizing the Look and Feel of MkDocs-Generated Pages

You can customize the appearance of your MkDocs-generated documentation to better align with your project's branding and enhance user experience through your Django `settings.py` file. This approach allows you to define default and role-specific customizations without modifying the codebase.

#### 1. Define Customization Settings in `settings.py`

Add a new dictionary called `MKDOCS_CUSTOM_SETTINGS` to your `settings.py` file:

```python
# settings.py

# MkDocs customization settings (optional)
MKDOCS_CUSTOM_SETTINGS = {
    'default': {
        'theme': {
            'name': 'material',
            'palette': {
                'primary': 'blue',
                'accent': 'light blue'
            },
            'font': {
                'text': 'Open Sans',
                'code': 'Source Code Pro'
            },
            'icon': {
                'logo': 'cloud',
                'repo': 'github'
            }
        },
        'extra_css': [
            'overrides/extra.css'
        ],
        'extra_javascript': [
            'overrides/extra.js'
        ],
        'plugins': [
            'search',
            'minify'
        ]
    },
    'admin': {
        'theme': {
            'palette': {
                'primary': 'red',
                'accent': 'blue'
            }
        }
    },
    'user': {
        'theme': {
            'palette': {
                'primary': 'green',
                'accent': 'teal'
            }
        }
    }
}
```
**It is up to you to install any plugins you use** - the minify plugin is not installed by default, eg. pip install mkdocs-minify-plugin


#### 2. Customising the HTML Template


### Customising Templates

#### 1 Create an overrides directory

Create a common `overrides` directory in your `docs` root directory to store shared customizations.

**Directory Structure:**

```
project_root/
├── docs/
│   ├── overrides/
│   │   ├── extra.js
│   │   └── partials/
│   │       └── header.html
│   ├── admin/
│   │   ├── index.md
│   ├── organiser/
│   │   ├── index.md
│   └── manager/
        ├── index.md
```

#### 1.2 Create the Custom JavaScript File (`extra.js`)

If there is custom javascript, include the `extra.js` file in the common `overrides` directory.

**Content of `docs/overrides/extra.js`:**

```javascript
function switchToMainApp() {
    if (window.opener && !window.opener.closed) {
        window.opener.focus();
        // Optionally, bring the documentation tab to the background
        window.blur();
    } else {
        alert('The main application window is not available.');
    }
}
```

#### 1.3 Create the Custom Template (`header.html`)

Place the custom `header.html` template in `docs/overrides/partials/`.

**Content of `docs/overrides/partials/header.html`:**

```html
{% extends "base.html" %}

{% block header %}
{{ super() }}
<nav class="md-header-nav">
    <a href="#" onclick="switchToMainApp()" class="md-header-nav__button">
        Back to Application
    </a>
</nav>
{% endblock %}
```

#### Additional Resources related to MkDocs

- **MkDocs Configuration Options**: [MkDocs Configuration](https://www.mkdocs.org/user-guide/configuration/)
- **Material Theme Customization**: [Material Theme](https://squidfunk.github.io/mkdocs-material/setup/changing-the-colors/)
- **MkDocs Plugins**: [MkDocs Plugins](https://github.com/mkdocs/mkdocs/wiki/MkDocs-Plugins)
Certainly! Let's modify the code and documentation to allow users to customize how each role is defined, rather than relying solely on Django groups. This will make your application more flexible and adaptable to different permission systems.

---

## Custom Role Definitions

If you don't want to use the default django groups, you can create your definitions via a new setting called `DOCSERVE_ROLE_DEFINITIONS` in `settings.py`. This setting will allow you to define how each role is determined for a user. You can specify role definitions using:

1. **Django Groups (Default Behavior):** The role name corresponds to a Django group name.
2. **Custom Functions:** Define a function that takes a `user` object and returns a boolean indicating whether the user has the role.
3. **Lambdas or Callable Objects:** Use lambdas or any callable that fits your needs.

We'll modify the `serve_docs` view and the `docs_home` view to use these customizable role definitions. We'll also update the documentation to reflect these changes.


### Step 1: Define Role Definitions in `settings.py`

Add a new setting `DOCSERVE_ROLE_DEFINITIONS` to your `settings.py` file:

```python
# settings.py

DOCSERVE_ROLE_DEFINITIONS = {
    'admin': lambda user: user.is_superuser,
    'user': lambda user: user.is_authenticated and not user.is_superuser,
    'manager': is_manager,
}

# Optionally, you can define functions
def is_manager(user):
    return user.is_authenticated and user.groups.filter(name='manager').exists()

DOCSERVE_ROLE_DEFINITIONS['manager'] = is_manager
```



### Step 4: Update Templates if Necessary

Ensure that your `docs_home.html` template uses the `roles` context variable correctly:

```html
<!-- docserve/templates/docserve/docs_home.html -->

<h1>Available Documentation</h1>
<ul>
    {% for role in roles %}
        <li><a href="{% url 'docserve:serve_docs_index' role=role %}">{{ role|title }} Documentation</a></li>
    {% endfor %}
</ul>
```

### Step 5: Use the Mixin to link docs to views

If you want to link your views to pages in the docs, add the `DocserveMixin` to your view and use in a similar way to defining templates.


#### 1. Import the Mixin

Import the `DocServeMixin` into your view module.

```python
from docserve.mixins import DocServeMixin
```

#### 2. Inherit from the Mixin

Include `DocServeMixin` in your view's inheritance list before the Django view class.

```python
from django.views.generic import CreateView
from docserve.mixins import DocServeMixin
from .models import Entry

class AddEntryView(DocServeMixin, CreateView):
    model = Entry
    template_name = 'entries/add_entry.html'
    docserve_page = 'guide/add_entry/'
```

#### 3. Specify the Documentation Page

You can specify the documentation page in two ways:

- **By setting the `docserve_page` attribute**: Provide the relative path to the documentation page.

  ```python
  docserve_page = 'guide/add_entry/'
  ```

- **By overriding the `get_docserve_page` method**: For dynamic determination of the documentation page.

  ```python
  def get_docserve_page(self):
      # Custom logic to determine the documentation page
      return 'guide/custom_page/'
  ```

#### 4. Accessing the Documentation URL in Templates

The mixin adds a `docserve_url` variable to the view's context. Use this variable in your templates to create links to the documentation.

```html
<!-- templates/entries/add_entry.html -->

{% extends "base.html" %}

{% block content %}
<h1>Add Entry</h1>

<!-- Your form goes here -->

{% if docserve_url %}
    <p>
        Need help? See the
        <a href="{{ docserve_url }}" target="docs_tab">documentation</a>.
    </p>
{% endif %}

{% endblock %}
```


#### Important Notes

- **Permissions are Evaluated at Runtime**: The role check functions are called each time a user requests documentation, ensuring up-to-date access control. 
- **Security**: Ensure that your role check functions are secure and correctly implement your access control logic.


**Explanation:**

- **Template Inheritance**: We extend the base template and override the `header` block.
- **`{{ super() }}`**: This includes the original content of the `header` block from the parent template.
- **Adding the Link**: We insert the "Back to Application" link into the header.

**Note**: The exact structure of the templates may vary based on the MkDocs Material theme version you're using. Ensure that the blocks you're overriding exist in your theme's templates.

### Step 2: Modify `MKDOCS_CUSTOM_SETTINGS` in `settings.py`

Update your `settings.py` to include the custom settings for MkDocs.

```python
# settings.py

MKDOCS_CUSTOM_SETTINGS = {
    'default': {
        'theme': {
            'name': 'material',
            'custom_dir': '../overrides',  # Relative to each role's docs_dir
        },
        'extra_javascript': [
            '../overrides/extra.js',  # Relative to each role's docs_dir
        ],
    },
    # You can still define role-specific settings if needed
}
```

## Contributing

Contributions are welcome! Please submit issues and pull requests for any features or bug fixes.

### License
This project is licensed under the MIT License.
=
